name: CI - Test and Package

on:
  # Manual trigger button in GitHub UI
  workflow_dispatch:
    inputs:
      artifact_name:
        description: "Name for the tarball (without extension)"
        required: false
        default: "scoreboard-demo"

  # Also run on PRs and pushes to main (optional but recommended)
  pull_request:
  push:
    branches: ["main"]

jobs:
  tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        run: |
          PYTHONPATH="$GITHUB_WORKSPACE" pytest -q

  package:
    name: Create Tarball Artifact
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set artifact variables
        id: vars
        run: |
          # Use workflow_dispatch input if present; otherwise default
          NAME="${{ github.event.inputs.artifact_name }}"
          if [ -z "$NAME" ]; then NAME="scoreboard-demo"; fi

          # Include short SHA for traceability
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          TARBALL="${NAME}-${SHORT_SHA}.tar.gz"

          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "tarball=$TARBALL" >> $GITHUB_OUTPUT

      - name: Create tar.gz (clean staging)
        run: |
           STAGE="$(mktemp -d)"
           rsync -a \
             --exclude ".git" \
             --exclude ".github" \
             --exclude "__pycache__" \
             --exclude ".pytest_cache" \
             --exclude ".venv" \
             --exclude "*.pyc" \
             --exclude "*.pyo" \
             . "$STAGE/"
           tar -C "$STAGE" -czf "${{ steps.vars.outputs.tarball }}" .

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.tarball }}
          path: ${{ steps.vars.outputs.tarball }}
          if-no-files-found: error
